# Evaluation Issues Log

## Date: 2025-10-31

### Issue 1: TASK_ID Unbound Variable
**Status:** ✅ RESOLVED

**Problem:**
```
/app/box_bootstrap.sh: line 10: TASK_ID: unbound variable
```

**Root Cause:**
The `box_bootstrap.sh` script uses `set -euo pipefail` which treats unset variables as errors. The Modal runner wasn't setting `TASK_ID` environment variable.

**Solution:**
1. Updated `scripts/modal_runner.py` to read `task_id` from `tb_meta.json` and set it as environment variable:
   ```python
   task_id = meta.get("task_id", "unknown")
   os.environ["TASK_ID"] = task_id
   ```

2. Updated `box_bootstrap.sh` to handle missing TASK_ID gracefully:
   ```bash
   export TASK_ID="${TASK_ID:-unknown}"
   ```

**Files Changed:**
- `scripts/modal_runner.py` (lines 124-140)
- `data/tasks/prepared/cli-eval-demo/overlay_files/box_bootstrap.sh` (line 10)

---

### Issue 2: Codex Command Not Found
**Status:** ✅ RESOLVED

**Problem:**
```
/app/box_bootstrap.sh: line 85: codex: command not found
```

**Root Cause:**
The Modal runner expected `codex-files` directory in the task, but it wasn't present. Codex CLI needs to be installed in the container.

**Solution:**
Updated `scripts/modal_runner.py` to install Codex via npm if `codex-files` is not available:
```python
if codex_src.exists():
    # Copy from codex-files
    ...
else:
    # Install codex via npm if codex-files not available
    print("[modal] Installing codex via npm...")
    subprocess.run(["bash", "-lc", "npm install -g @openai/codex"], check=False)
```

**Files Changed:**
- `scripts/modal_runner.py` (lines 73-91)

---

### Issue 3: Codex Authentication 401 Errors
**Status:** ✅ RESOLVED (Authentication working, but quota issue)

**Problem:**
```
http.response.status_code=401 Unauthorized
ERROR: exceeded retry limit, last status: 401 Unauthorized
```

**Root Cause:**
Codex CLI requires authentication configuration. The API key needs to be provided either:
1. Via environment variable `OPENAI_API_KEY`
2. Via Codex config file or auth.json

**Solution:**
1. Created Codex config file at `/root/.codex/config.toml`:
   ```toml
   model_provider = "openai"
   model = "gpt-5-mini"
   ```

2. Created `auth.json` file at `/root/.codex/auth.json`:
   ```json
   {
     "api_key": "...",
     "OPENAI_API_KEY": "..."
   }
   ```

3. Set environment variables:
   ```python
   os.environ["OPENAI_API_KEY"] = openai_api_key
   os.environ["OPENAI_MODEL"] = model
   ```

**Files Changed:**
- `scripts/modal_runner.py` (lines 120-134)

**Verification:**
After fix, logs show successful authentication:
```
auth_mode="ApiKey" 
http.response.status_code=200
```

---

### Issue 4: API Quota Exceeded
**Status:** ⚠️ CURRENT ISSUE (Not a code problem)

**Problem:**
```
ERROR: stream disconnected before completion: You exceeded your current quota, 
please check your plan and billing details.
```

**Root Cause:**
The OpenAI API key in use has exceeded its quota limit. This is an account/billing issue, not a code problem.

**Evidence:**
- Authentication is working correctly (`auth_mode="ApiKey"`, `status_code=200`)
- Codex CLI initialized successfully
- API request was made but rejected due to quota

**Solution:**
Use a different API key with available quota, or:
1. Check OpenAI account billing/quota
2. Add credits to the account
3. Use a different API key

**No code changes needed** - the infrastructure is working correctly.

---

### Issue 5: Empty Diff Results
**Status:** ⚠️ EXPECTED (Due to quota error)

**Problem:**
```
[results] Git diff (modal):
(empty)
[results] Rubric total score: 0%
```

**Root Cause:**
Codex failed to complete the task due to quota error, so no changes were made to the repository.

**Expected Resolution:**
Once quota issue is resolved and Codex completes successfully, the diff should contain the changes made by the agent.

---

## Summary

### Resolved Issues
1. ✅ TASK_ID unbound variable - Fixed by setting TASK_ID from task metadata
2. ✅ Codex command not found - Fixed by adding npm install fallback
3. ✅ Codex authentication 401 errors - Fixed by creating config and auth.json files

### Current Issues
1. ⚠️ API quota exceeded - Requires valid API key with available quota (account issue, not code issue)

### Infrastructure Status
- ✅ Modal runner is working correctly
- ✅ Codex CLI authentication is configured properly
- ✅ Task preparation is complete
- ✅ Environment variables are being passed correctly
- ✅ Evaluation datapoint is ready for use

### Next Steps
1. Use an API key with available quota
2. Re-run evaluation: `SANDBOX_BACKEND=modal scripts/run_codex_box.sh data/tasks/prepared/cli-eval-demo`
3. Evaluation should complete successfully once quota is available

---

## Testing Notes

**Last Successful Authentication:**
- Modal run ID: `ap-BhfR0G66mC5C8KAiOwkpfk`
- Authentication mode: `ApiKey`
- Status: Authenticated successfully (200), but quota exceeded

**Files Modified During Fixes:**
- `scripts/modal_runner.py` - Added TASK_ID handling, Codex installation fallback, auth.json creation
- `data/tasks/prepared/cli-eval-demo/overlay_files/box_bootstrap.sh` - Added TASK_ID default value

**Configuration:**
- Authentication mode: API key (`eval_billing = "api"` in `eval.toml`)
- Model: `gpt-5-mini`
- Task: `cli-eval-demo` (Add CLI Usage Section to README)

